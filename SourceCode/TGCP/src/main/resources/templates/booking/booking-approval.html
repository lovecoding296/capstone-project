<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Payment Page</title>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" th:href="@{/style.css}">
	<script th:src="@{/jquery-3.6.0.min.js}"></script>
	<script th:src="@{/app-script.js}"></script>

	<!-- Flatpickr CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

	<!-- Flatpickr JS -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<style>
		#user-profile {
			display: flex;
			align-items: center;
			border: 1px solid #ccc;
			padding: 10px;
			max-width: 300px;
		}

		#user-image {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			background-color: #ccc;
			margin-right: 15px;
		}

		#user-info {
			display: flex;
			flex-direction: column;
		}

		#user-name {
			font-weight: bold;
			font-size: 16px;
		}

		#user-rating,
		#user-participants {
			font-size: 14px;
			color: #666;
		}
	</style>

	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {

			const urlParts = window.location.pathname.split('/');
			const bookingId = urlParts[urlParts.length - 1];

			fetch(`/api/bookings/${bookingId}`)
				.then(response => response.json())
				.then(data => {

					console.log(data)



					document.getElementById("destination").innerText = data.destination;
					document.getElementById("start-date").innerText = data.startDate;
					document.getElementById("end-date").innerText = data.endDate;
					document.getElementById("num-people").innerText = data.numberOfPeople;


					document.getElementById("user-image").src = data.customer.avatarUrl;
					document.getElementById("user-link").href = "/users/" + data.customer.id;
					document.getElementById("user-name").innerText = data.customer.fullName;
					document.getElementById("user-rating").innerText = `⭐ ${data.customer.averageRating}/5`;

					// Lấy danh sách payments từ data.payments
					const payments = data.payments;
					const paymentList = document.getElementById("payment-list");
					paymentList.innerHTML = ""; // Xóa dữ liệu cũ nếu có

					if (!payments || payments.length === 0) {
						paymentList.innerHTML = "<tr><td colspan='5'>No payments found.</td></tr>";
						return;
					}

					payments.forEach(payment => {
						const row = document.createElement("tr");
						row.id = `payment-row-${payment.id}`; // Đặt ID cho từng dòng

						// Thêm dropdown để chọn trạng thái
						const statusSelect = `
							<select class="form-select form-select-sm status-select" onchange="updateStatus(${payment.id}, this.value)">
							  <option value="PENDING" ${payment.status === "PENDING" ? "selected" : ""}>PENDING</option>
							  <option value="RECEIVED" ${payment.status === "RECEIVED" ? "selected" : ""}>RECEIVED</option>
							</select>

					    `;

						row.innerHTML = `
							<td>
					            ${payment.transactionImageUrl ?
								`<img src="${payment.transactionImageUrl}" alt="Payment Image" style="max-width: 100px; max-height: 100px; cursor: pointer;" onclick="viewFullImage('${payment.transactionImageUrl}')">`
								: "No Image"}
					        </td>
					        <td class="sender-name">${payment.senderAccountName}</td>
					        <td class="amount">${payment.amount}</td>
					        <td class="transaction-note">${payment.transactionNote || "N/A"}</td>		        
					        <td class="sender-account-number">${payment.senderAccountNumber}</td>
							<td>${statusSelect}</td>
					    `;
						paymentList.appendChild(row);
					});

				});
		});

		function updateStatus(paymentId, newStatus) {

			console.log(JSON.stringify({['status']: newStatus}))


			fetch(`/api/payments/${paymentId}`, {
				method: "PATCH",
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({['status']: newStatus})
			})
				.then(response => {
					if (response.ok) {
						alert("Payment updated successfully!");
						//location.reload(); // Tải lại danh sách payment
					} else {
						alert("Failed to update payment.");
					}
				})
				.catch(error => console.error("Error updating payment:", error));
		}


	</script>
</head>

<body>
	<nav th:replace="~{page-component :: header}"></nav>
	<div class="container mt-4">
		<h2 class="page-title">Booking Information</h2>
		<div class="row">
			<!-- Booking Info (Bên trái) -->
			<div class="col-md-6">

				<p><strong>Detail destination:</strong> <span id="destination"></span></p>
				<p><strong>Start date:</strong> <span id="start-date"></span></p>
				<p><strong>End date:</strong> <span id="end-date"></span></p>
				<p><strong>Số người tham gia:</strong> <span id="num-people"></span></p>
				<p><strong>Total price:</strong> <span id="total-price"></span></p>
			</div>

			<!-- User Card (Bên phải) -->
			<div class="col-md-6 d-flex justify-content-center">


				<div id="user-profile" class="card" style="width: 18rem; border-radius: 12px;">
					<img id="user-image" class="card-img-top rounded-circle mx-auto" alt="Guide Avatar"
						style="width: 120px; height: 120px; object-fit: cover; margin-top: -60px;">
					<div class="card-body">
						<div id="user-info">
							<a id="user-link" href="#"><div id="user-name">Tên Người Dùng</div></a>
							<div id="user-rating">⭐ 4.5/5</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">

			<div class="table-responsive">
				<table class="table table-bordered table-striped align-middle text-center">
					<thead class="table-dark">
						<tr>
							<th>Ảnh chuyển tiền</th>
							<th>Tên chủ tài khoản</th>
							<th>Số tiền</th>
							<th>Nội dung chuyển khoản</th>
							<th>Số tài khoản</th>
							<th>Thay đổi Status</th>

						</tr>
					</thead>
					<tbody id="payment-list">
						<tr>
							<td colspan="7">Loading...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<footer th:replace="~{page-component :: footer}"></footer>

</body>

</html>