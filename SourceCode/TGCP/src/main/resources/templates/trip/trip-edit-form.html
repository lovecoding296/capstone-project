<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tạo/Chỉnh sửa chuyến đi</title>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" th:href="@{/style.css}">
	<script th:src="@{/jquery-3.6.0.min.js}"></script>
	<script th:src="@{/app-script.js}"></script>

	<script th:src="@{/ckeditor/ckeditor.js}"></script>

	<style>
		.scrollable-dropdown {
			max-height: 200px;
			/* Giới hạn chiều cao */
			overflow-y: auto;
			/* Thêm thanh cuộn khi danh sách dài */
			width: 250px;
			/* Định dạng chiều rộng */
			padding: 10px;
			/* Khoảng cách bên trong */
		}
	</style>
</head>

<body>

	<nav th:replace="~{page-component :: header}"></nav>

	<h3 class="text-center page-title"
		th:text="${#strings.isEmpty(trip.id) ? 'Tạo chuyến đi mới' : 'Chỉnh sửa chuyến đi'}">
	</h3>
	<form th:action="@{${#strings.isEmpty(trip.id) ? '/trips/new' : '/trips/' + trip.id + '/edit'}}" th:object="${trip}"
		method="post" class="container mt-4" enctype="multipart/form-data">

		<!-- Upload nhiều ảnh -->
		<div class="mb-3">
			<label for="images" class="form-label">Tải lên ảnh</label>
			<input type="file" id="images" name="files" multiple accept="image/*" class="form-control"
				onchange="previewImages()">
		</div>

		<!-- Khu vực xem trước ảnh -->
		<div id="previewContainer" class="d-flex flex-wrap"></div>

		<!-- Hiển thị ảnh đã tải lên trước đó -->
		<div id="existingImages" class="d-flex flex-wrap">
			<div th:each="image : ${trip.images}" class="position-relative m-2">
				<img th:src="@{${image.url}}" class="rounded shadow-sm"
					style="width: 150px; height: 150px; object-fit: cover;">
				<!-- Nút xóa ảnh đã tải lên -->
				<button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0"
					th:onclick="removeExistingImage([[${image.url}]])">X</button>
			</div>
		</div>

		<!-- Thêm hidden input để gửi imagesToDelete -->
		<input type="hidden" id="imagesToDelete" name="imagesToDelete">



		<script>
			// Xem trước ảnh mới
			function previewImages() {
				console.log("onchange previewImages")
				
				const input = document.getElementById("images");
				const files = input.files;
				// Kiểm tra số lượng file chọn vào (tối đa 5 ảnh)				

				// Sử dụng th:with để gán giá trị trip.imageUrls.size() vào biến JavaScript
				const existFileCount = [[${trip.images.size()}]]; // Lấy số lượng ảnh đã có trong database
				const totalFileCount = files.length + existFileCount;

				// Kiểm tra nếu tổng số file (mới + cũ) vượt quá 5
				if (totalFileCount > 5) {
					alert("Bạn chỉ có thể chọn tối đa 5 ảnh.");
					input.value = ''; // Reset lại input nếu vượt quá 5 ảnh
					return;
				}


				const previewContainer = document.getElementById("previewContainer");

				previewContainer.innerHTML = "";  // Xóa preview cũ

				// Render preview mới
				for (let i = 0; i < input.files.length; i++) {
					const file = input.files[i];
					const reader = new FileReader();

					reader.onload = (e) => {
						const imgWrapper = document.createElement("div");
						imgWrapper.classList.add("position-relative", "m-2");
						imgWrapper.style.transition = "opacity 0.3s";

						const img = document.createElement("img");
						img.src = e.target.result;
						img.classList.add("rounded", "shadow-sm");
						img.style.width = "150px";
						img.style.height = "150px";
						img.style.objectFit = "cover";

						// Nút xóa
						const removeBtn = document.createElement("button");
						removeBtn.textContent = "X";
						removeBtn.classList.add("btn", "btn-danger", "btn-sm", "position-absolute", "top-0", "end-0");
						removeBtn.onclick = () => removeImage(i);

						imgWrapper.appendChild(img);
						imgWrapper.appendChild(removeBtn);
						previewContainer.appendChild(imgWrapper);
					};

					reader.readAsDataURL(file);
				}
			}

			// Xóa ảnh trong preview
			function removeImage(index) {
				const input = document.getElementById("images");
				const dataTransfer = new DataTransfer();

				for (let i = 0; i < input.files.length; i++) {
					if (i !== index) {
						dataTransfer.items.add(input.files[i]);
					}
				}

				input.files = dataTransfer.files;

				previewImages();
			}

			function removeExistingImage(imageUrl) {
				const existingImagesDiv = document.getElementById("existingImages");

				// Xóa ảnh trong UI (có thể gửi request xóa ảnh sau)
				const imageDiv = Array.from(existingImagesDiv.children).find(div => {
					const img = div.querySelector('img');
					// Kiểm tra nếu thẻ img tồn tại
					return img && img.src.includes(imageUrl);
				});

				if (imageDiv) {
					existingImagesDiv.removeChild(imageDiv);
				}

				// Thêm ảnh cần xóa vào danh sách ẩn hoặc gửi request lên backend
				const hiddenInput = document.getElementById("imagesToDelete");
				if (hiddenInput) {
					hiddenInput.value += imageUrl + ";";  // Thêm ảnh vào danh sách ẩn (hoặc có thể sử dụng một Array để lưu)
				}
			}
		</script>
		<br><br>

		<div class="mb-3">
			<label for="title" class="form-label">Tiêu đề</label>
			<input type="text" th:field="*{title}" class="form-control" required>
		</div>

		<div class="mb-3">
			<label for="destination" class="form-label">Thành phố</label>
			<input type="text" th:field="*{city}" class="form-control" required>
		</div>

		<div class="mb-3">
			<label for="category" class="form-label">Danh mục</label>
			<select id="category" name="category" th:field="*{category}" class="form-control" required>
				<option value="">-- Chọn danh mục --</option>
				<option th:each="cat : ${categories}" th:value="${cat}" th:text="${#messages.msg(cat.name())}"></option>
			</select>
		</div>

		<div class="mb-3">
			<label class="form-check-label">
				<input type="checkbox" id="ageRestricted" name="ageRestricted" th:field="*{ageRestricted}"
					class="form-check-input" onchange="toggleAgeInputs()">
				Giới hạn độ tuổi
			</label>
		</div>

		<div id="ageInputs" class="mb-3" style="display: none;"></div>

		<script>
			// Hàm tạo ra HTML cho input tuổi khi checkbox được chọn
			function toggleAgeInputs() {
				const ageRestricted = document.getElementById("ageRestricted").checked;
				const ageInputsContainer = document.getElementById("ageInputs");

				// Nếu checkbox được chọn, tạo HTML cho input tuổi
				if (ageRestricted) {
					ageInputsContainer.style.display = "block";
					// Chỉ tạo ra các input nếu chưa được tạo
					if (!ageInputsContainer.innerHTML.trim()) {
						const ageInputsHTML = `
		                    <div class="row">
		                        <div class="col">
		                            <label for="fromAge" class="form-label">Từ tuổi</label>
		                            <input type="number" id="fromAge" name="fromAge" th:field="*{fromAge}" class="form-control" min="1" max="100" required>
		                        </div>
		                        <div class="col">
		                            <label for="toAge" class="form-label">Đến tuổi</label>
		                            <input type="number" id="toAge" name="toAge" th:field="*{toAge}" class="form-control" min="1" max="100" required>
		                        </div>
		                    </div>`;
						ageInputsContainer.innerHTML = ageInputsHTML;
					}
				} else {
					// Ẩn input nếu checkbox không được chọn
					ageInputsContainer.style.display = "none";
					ageInputsContainer.innerHTML = ""; // Xóa HTML khi ẩn
				}
			}

			// Đảm bảo hiển thị đúng trạng thái khi tải lại trang (khi edit trip)
			document.addEventListener("DOMContentLoaded", () => {
				toggleAgeInputs();
			});
		</script>




		<div class="mb-3">
			<label for="startDate" class="form-label">Ngày bắt đầu</label>
			<input type="datetime-local" name="startDate" th:value="*{startDate}" class="form-control" required>
			<!--<input type="datetime-local" value="2025-03-22T20:30" class="form-control" required>-->

		</div>

		<div class="mb-3">
			<label for="endDate" class="form-label">Ngày kết thúc</label>
			<input type="datetime-local" name="endDate" th:value="*{endDate}" class="form-control" required />






		</div>





		<div class="mb-3">
			<h3 class="text-center">Tạo lịch trình chuyến đi</h3>

			<button type="button" class="btn btn-primary mb-3" onclick="addItinerary()">+ Thêm lịch trình</button>

			<div id="itineraryContainer"></div>

		</div>

		<script>
			let itineraryIndex = 0;

			// Thêm lịch trình mới
			function addItinerary() {
				const container = document.getElementById("itineraryContainer");

				const itineraryDiv = document.createElement("div");
				itineraryDiv.classList.add("card", "p-3", "mb-4");
				itineraryDiv.setAttribute("id", `itinerary-${itineraryIndex}`);

				itineraryDiv.innerHTML = `
		            <div class="d-flex justify-content-between align-items-center mb-3">
		                <h4>Lịch trình #${itineraryIndex + 1}</h4>
		                <button type="button" class="btn btn-danger btn-sm" onclick="removeItinerary(${itineraryIndex})">Xóa</button>
		            </div>

		            <div class="row">
		                <!-- Số ngày -->
		                <div class="col-md-3">
		                    <label for="dayCount-${itineraryIndex}" class="form-label">Số ngày</label>
		                    <input type="number" id="dayCount-${itineraryIndex}" name="itineraries[${itineraryIndex}].dayCount"
		                           class="form-control" min="1" required>
		                </div>

		                <!-- Hoạt động -->
		                <div class="col-md-9">
		                    <h5>Hoạt động</h5>
		                    <div id="activityContainer-${itineraryIndex}"></div>
		                    <button type="button" class="btn btn-outline-primary mt-2"
		                            onclick="addActivity(${itineraryIndex})">+ Thêm hoạt động</button>
		                </div>
		            </div>
		        `;

				container.appendChild(itineraryDiv);
				itineraryIndex++;
			}

			// Xóa lịch trình
			function removeItinerary(index) {
				const itinerary = document.getElementById(`itinerary-${index}`);
				itinerary.remove();
			}

			// Thêm hoạt động vào lịch trình
			function addActivity(itineraryIndex) {
				const container = document.getElementById(`activityContainer-${itineraryIndex}`);

				const activityIndex = container.querySelectorAll('.activity').length;

				const activityDiv = document.createElement("div");
				activityDiv.classList.add("activity", "border", "p-3", "mt-2");
				activityDiv.setAttribute("id", `activity-${itineraryIndex}-${activityIndex}`);

				activityDiv.innerHTML = `
		            <div class="d-flex justify-content-between align-items-center">
		                <h6>Hoạt động #${activityIndex + 1}</h6>
		                <button type="button" class="btn btn-danger btn-sm" 
		                        onclick="removeActivity(${itineraryIndex}, ${activityIndex})">Xóa</button>
		            </div>

		            <div class="row mt-2">
		                <div class="col-md-6">
		                    <label for="title-${itineraryIndex}-${activityIndex}" class="form-label">Tiêu đề</label>
		                    <input type="text" id="title-${itineraryIndex}-${activityIndex}" 
		                           name="itineraries[${itineraryIndex}].activities[${activityIndex}].title"
		                           class="form-control" placeholder="Nhập tiêu đề" required>
		                </div>
		                <div class="col-md-6">
		                    <label for="description-${itineraryIndex}-${activityIndex}" class="form-label">Mô tả</label>
		                    <textarea id="description-${itineraryIndex}-${activityIndex}" 
		                              name="itineraries[${itineraryIndex}].activities[${activityIndex}].description"
		                              class="form-control" placeholder="Nhập mô tả hoạt động" required></textarea>
		                </div>
		            </div>
		        `;

				container.appendChild(activityDiv);
			}

			// Xóa hoạt động
			function removeActivity(itineraryIndex, activityIndex) {
				const activity = document.getElementById(`activity-${itineraryIndex}-${activityIndex}`);
				activity.remove();
			}
		</script>





		<!--		--------------------------------------
		<div class="d-flex">
			 Dropdown chọn ngôn ngữ 
			<div class="dropdown me-3">
				<button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
					Chọn ngôn ngữ
				</button>
				<ul class="dropdown-menu scrollable-dropdown">
					<li th:each="lang : ${languages}">
						<input type="checkbox" th:id="${'lang_' + lang}" th:name="languages" th:value="${lang}"
							th:checked="${#sets.contains(trip.languages, lang)}" class="form-check-input lang-checkbox"
							onchange="updateSelectedLanguages()">
						<label th:for="${'lang_' + lang}" class="form-check-label" th:text="${lang}"></label>
					</li>
				</ul>
			</div>

			 Danh sách ngôn ngữ đã chọn 
			<div>
				<p id="selectedLanguages"></p>
			</div>
		</div>

		<script>
			function updateSelectedLanguages() {
				let selectedLanguages = [];
				document.querySelectorAll('.lang-checkbox:checked').forEach(checkbox => {
					selectedLanguages.push(checkbox.value);
				});

				let display = selectedLanguages.length > 0 ? selectedLanguages.join(', ') : "";
				document.getElementById('selectedLanguages').innerText = display;
			}

			// Gọi hàm này khi trang tải để hiển thị danh sách ngôn ngữ đã chọn sẵn
			document.addEventListener("DOMContentLoaded", updateSelectedLanguages);

		</script>-->



		<div class="mb-3">
			<label for="description" class="form-label">Mô tả chi tiết</label>
			<textarea th:field="*{description}" class="form-control" rows="4" required></textarea>
		</div>

		<div class="mb-3">
			<label for="price" class="form-label">Giá</label>
			<input type="number" th:field="*{price}" class="form-control" required>
		</div>

		<div class="mb-3">
			<label for="maxParticipants" class="form-label">Số người tham gia tối đa</label>
			<input type="number" th:field="*{maxParticipants}" class="form-control" min="2" required>
		</div>


		<button type="submit" class="btn btn-primary">Lưu chuyến đi</button>
		<a sec:authorize="!isAnonymous()" th:href="@{/trips/creator/{id}(id=${session.loggedInUser.id})}"
			class="btn btn-secondary">Hủy</a>
	</form>

	<script>
		document.getElementById("addParticipant").addEventListener("click", function () {
			let email = document.getElementById("participantEmail").value;

			if (!email) {
				alert("Vui lòng nhập email");
				return;
			}

			fetch("/api/users/by-email?email=" + email) // Gọi API tìm user theo email
				.then(response => {
					if (!response.ok) throw new Error("Không tìm thấy user");
					return response.json();
				})
				.then(user => {
					let list = document.getElementById("participantList");
					let participantsField = document.getElementById("participants");

					// Kiểm tra user đã được thêm chưa
					if (participantsField.value.includes(user.id)) {
						alert("Người này đã có trong danh sách!");
						return;
					}

					// Thêm vào danh sách hiển thị
					let li = document.createElement("li");
					li.textContent = user.fullName + " (" + user.email + ")";
					list.appendChild(li);

					// Cập nhật danh sách participants
					participantsField.value += user.id + ",";
				})
				.catch(error => alert(error.message));
		});
	</script>




	<script>
		// Lấy tất cả các textarea
		const textareas = document.querySelectorAll('textarea');

		// Khởi tạo CKEditor cho mỗi textarea
		textareas.forEach(textarea => {
			CKEDITOR.replace(textarea, {
				versionCheck: false,
				extraPlugins: 'videoembed',
			});
		});


	</script>


	<footer th:replace="~{page-component :: footer}"></footer>

</body>

</html>