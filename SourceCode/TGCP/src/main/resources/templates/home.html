<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" th:href="@{/style.css}">
	<script th:src="@{/jquery-3.6.0.min.js}"></script>
	<script th:src="@{/app-script.js}"></script>
	
	<!-- Flatpickr CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

	<!-- Flatpickr JS -->
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

	
	<style>
		.post-card {
			border-radius: 10px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			transition: transform 0.2s ease-in-out;
		}

		.post-card-body {
			padding: 1.5rem;
		}

		.post-card-title {
			font-weight: bold;
			color: #333;
		}

		.post-card-footer {
			background-color: #f8f9fa;
			padding: 10px;
			border-top: 1px solid #ddd;
			display: flex;
			justify-content: start;
			gap: 10px;
		}

		.post-card .text-muted {
			font-size: 0.9rem;
		}

		.post-card strong {
			color: #555;
		}

		.post-card .like-comment-count {
			font-size: 1rem;
			font-weight: bold;
			color: #007bff;
		}

		.post-card .btn-like {
			background-color: #f8f9fa;
			border: 1px solid #007bff;
			color: #007bff;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-like:hover {
			background-color: #007bff;
			color: white;
		}

		.post-card .btn-comment {
			background-color: #f8f9fa;
			border: 1px solid #28a745;
			color: #28a745;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-comment:hover {
			background-color: #28a745;
			color: white;
		}

		.post-card .comment-section {
			border-top: 1px solid #ddd;
			margin-top: 15px;
			padding-top: 10px;
		}

		.post-card .comment-input {
			border-radius: 20px;
			padding: 10px;
		}

		.post-card .comment-form button {
			border-radius: 20px;
			margin-top: 10px;
		}

		.tour-card-home {
			border-radius: 12px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
			transition: transform 0.3s ease-in-out;
			padding: 20px;
		}

		.tour-card-home:hover {
			transform: scale(1.03);
		}

		.tour-card-home img {
			width: 100%;
			/* ƒê·∫£m b·∫£o ·∫£nh chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa container */
			height: 200px;
			/* ƒê·∫∑t chi·ªÅu cao c·ªë ƒë·ªãnh cho ·∫£nh */
			object-fit: cover;
			/* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã bi·∫øn d·∫°ng m√† v·∫´n ph·ªß k√≠n kh√¥ng gian */
		}
		
		.user-list {
		  max-width: 1200px;
		  margin: 0 auto;
		  display: grid;
		  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		  gap: 20px;
		}

		.user-card {
		  background-color: #fff;
		  border-radius: 16px;
		  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
		  padding: 20px;
		  text-align: center;
		}

		.user-card img {
		  width: 96px;
		  height: 96px;
		  object-fit: cover;
		  border-radius: 50%;
		  margin-bottom: 12px;
		}

		.user-card h2 {
		  font-size: 20px;
		  margin: 0;
		}

		.user-card .rating {
		  font-size: 14px;
		  color: #888;
		  margin: 4px 0;
		}

		.user-card .city {
		  font-size: 14px;
		  color: #555;
		  margin-bottom: 12px;
		}

		.user-card .buttons {
		  display: flex;
		  justify-content: center;
		  gap: 10px;
		}

		.user-card button {
		  padding: 8px 14px;
		  border: none;
		  border-radius: 8px;
		  cursor: pointer;
		  font-size: 14px;
		  color: #fff;
		  transition: background-color 0.3s ease;
		}

		.btn-message {
		  background-color: #007bff;
		}

		.btn-message:hover {
		  background-color: #0056b3;
		}

		.btn-hire {
		  background-color: #28a745;
		}

		.btn-hire:hover {
		  background-color: #1e7e34;
		}
		
		
		.modal {
		    position: fixed;
		    top: 0; left: 0;
		    width: 100%; height: 100%;
		    background-color: rgba(0,0,0,0.5);
		    justify-content: center;
		    align-items: center;
		    display: flex;
		    z-index: 1000;
		  }
		  .modal-content {
		    background: white;
		    padding: 24px;
		    border-radius: 10px;
		    width: 400px;
		    position: relative;
		  }
		  .close {
		    position: absolute;
		    top: 8px; right: 12px;
		    font-size: 20px;
		    cursor: pointer;
		  }
	</style>

</head>

<body>
	<nav th:replace="~{page-component :: header}"></nav>
	
	<div class="text-center page-title">
		<svg th:replace="~{icons :: person}"></svg>
	</div>
	<h3 class="text-center" style="margin-top: 10px;">H∆∞·ªõng d·∫´n vi√™n n·ªïi b·∫≠t</h3>

	<div class="user-list">
		<div class="user-card" th:each="user : ${users}">
			<img th:src="${user.avatarUrl}" th:alt="${user.fullName}">
			<h2 th:text="${user.fullName}">T√™n ng∆∞·ªùi d√πng</h2>
			<div class="rating">
				‚≠ê <span th:text="${user.averageRating}">4.5</span> (<span th:text="${user.reviewCount}">100</span> ƒë√°nh gi√°)
			</div>
			<div class="city" th:text="${user.city}">Th√†nh ph·ªë</div>
			<div class="buttons">
				<button class="btn-message">G·ª≠i tin nh·∫Øn</button>
				<button class="btn-hire"
				        th:attr="onclick=|openBookingPopup(${user.id}, '${user.fullName}')|">
				    Thu√™
				</button>


			</div>
		</div>
	</div>
	
	<!-- Modal -->
	<div id="bookingModal" class="modal" style="display:none;">
	  <div class="modal-content">
	    <span class="close" onclick="closeBookingPopup()">&times;</span>
	    <h3>Thu√™ h∆∞·ªõng d·∫´n vi√™n: <span id="guideName"></span></h3>

	    <form id="bookingForm">
	      <input type="hidden" id="guideId" name="guideId">

		  <label>Ch·ªçn ng√†y:</label>
		  <input id="dateRange" type="text" placeholder="Ch·ªçn ng√†y" required>
		  <input type="hidden" id="startDate" name="startDate">
		  <input type="hidden" id="endDate" name="endDate">


	      <label>S·ªë ng∆∞·ªùi tham gia:</label>
	      <input type="number" id="numPeople" name="numPeople" min="1" value="1" required>

	      <label>ƒê·ªãa ƒëi·ªÉm c·ª• th·ªÉ:</label>
	      <input type="text" name="locationDetail" required>

	      <p><strong>T·ªïng ti·ªÅn: <span id="totalPrice">0</span> VND</strong></p>

	      <button type="submit">X√°c nh·∫≠n ƒë·∫∑t l·ªãch</button>
	    </form>
	  </div>
	</div>


	<div class="container-fluid page-title">
		<div class="card p-3 shadow">
			<h4 class="text-start mb-3" th:text="#{label.searchTours}">T√¨m ki·∫øm b√†i vi·∫øt</h4>
			<form th:action="@{/posts/search}" method="get">
				<div class="row d-flex align-items-center g-2">

					<!-- ƒê·ªãa ƒëi·ªÉm -->
					<div class="col-md-2">
						<input type="text" name="title" class="form-control" th:placeholder="#{label.title}">
					</div>
					<!-- ƒê·ªãa ƒëi·ªÉm -->
					<div class="col-md-2">
						<input type="text" name="author" class="form-control" th:placeholder="#{label.author}">
					</div>

					<!-- Danh m·ª•c -->
					<div class="col-md-2">
						<select id="category" name="category" class="form-select">
							<option value="" th:text="#{label.category}">Danh m·ª•c</option>
							<option th:each="cat : ${postCategories}" th:value="${cat}"
								th:text="${#messages.msg(cat.name())}"></option>
						</select>
					</div>

					<!-- N√∫t t√¨m ki·∫øm -->
					<div class="col-md-2 text-end">
						<button type="submit" class="btn btn-primary w-100" th:text="#{label.search}">üîç T√¨m
							ki·∫øm</button>
					</div>
				</div>
			</form>
		</div>
	</div>




	<div class="text-center page-title">
		<svg th:replace="~{icons :: blog}"></svg>
	</div>
	<h3 class="text-center" style="margin-top: 10px;">C√°c b√†i vi·∫øt n·ªïi b·∫≠t</h3>

	<div class="container mt-4">
		<div class="row">
			<div th:each="post : ${posts}" class="col-md-12">
				<div class="post-card mb-4">
					<div class="post-card-body">
						<h5 class="post-card-title" th:text="${post.title}"></h5>
						<p class="text-muted">
							<strong th:text="#{label.postedOn}"></strong>
							<span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
						</p>
						<p><strong th:text="#{label.author}"></strong> <span th:text="${post.author.fullName}"></span>
						</p>
						<p><strong th:text="#{label.category}"></strong> <span
								th:text="${#messages.msg(post.category.name)}"></span>
						</p>
						<p><strong th:text="#{label.content}"></strong> <span th:utext="${post.content}"></span></p>

						<p>
							<span class="like-comment-count">
								üëç <span th:id="'like-count-' + ${post.id}"
									th:text="${post.likes != null ? post.likes.size() : 0}">0</span> |
								üí¨ <span th:text="${post.comments != null ? post.comments.size() : 0}">0</span>
							</span>
						</p>
					</div>

					<div class="post-card-footer">
						<button class="btn btn-like btn-sm" th:id="'like-button-' + ${post.id}"
							th:attr="onclick='toggleLike(' + ${post.id} + ')'" th:text="#{label.like}">
						</button>

						<button class="btn btn-comment btn-sm" th:attr="onclick='loadComments(' + ${post.id} + ')'"
							th:text="#{label.viewComments}">
						</button>
					</div>

					<div class="post-card-body comment-section">
						<h6 class="post-card-title" th:text="#{label.comments}"></h6>
						<div th:id="'comment-section-' + ${post.id}" class="mt-3"></div>

						<!-- Form th√™m b√¨nh lu·∫≠n -->
						<form th:attr="onsubmit='addComment(event, ' + ${post.id} + ')'" class="comment-form">
							<input type="text" th:id="'comment-content-' + ${post.id}"
								class="form-control comment-input" th:placeholder="#{label.enterComment}" required>
							<button type="submit" class="btn btn-success btn-sm" th:text="#{label.send}"></button>
						</form>
					</div>
				</div>
			</div>

			<script>
				function toggleLike(postId) {
					fetch(`/api/likes/${postId}`, {method: 'POST'})
						.then(response => {
							if (!response.ok) {
								throw new Error(`L·ªói HTTP: ${response.status}`);
							}
							return response.json();
						})
						.then(data => {
							const likeCountElement = document.getElementById(`like-count-${postId}`);
							if (likeCountElement) {
								likeCountElement.innerText = data.likeCount;
							}

							const likeButton = document.getElementById(`like-button-${postId}`);
							if (likeButton) {
								likeButton.classList.toggle('liked', data.liked); // ƒê·ªïi class khi ƒë√£ th√≠ch
							}
						})
						.catch(error => console.error("L·ªói:", error));
				}

				function addComment(event, postId) {
					event.preventDefault();
					const content = document.getElementById(`comment-content-${postId}`).value;

					fetch(`/api/comments/post/${postId}`, {
						method: "POST",
						headers: {"Content-Type": "application/json"},
						body: JSON.stringify({content: content})
					})
						.then(response => response.json())
						.then(data => {
							loadComments(postId)
						})
						.catch(error => console.error("L·ªói:", error));
				}

				function loadComments(postId) {
					fetch(`/api/comments/post/${postId}`)
						.then(response => response.json())
						.then(comments => {
							let commentSection = document.getElementById(`comment-section-${postId}`);
							commentSection.innerHTML = ""; // X√≥a n·ªôi dung c≈©

							comments.forEach(comment => {
								let commentHtml = `
				                        <div class="mb-2">
				                            <p><strong>${comment.commenter.fullName}</strong></p>
				                            <p>${comment.content}</p>
				                            <p class="text-muted">
				                                <small>${new Date(comment.createdAt).toLocaleString()}</small>
				                            </p>
				                            <hr>
				                        </div>
				                    `;
								commentSection.innerHTML += commentHtml;
							});
						})
						.catch(error => console.error("Error loading comments:", error));
				}
			</script>
			
			<script>
			  const BusyDates = {
			    // userId: ["2025-04-25", "2025-04-26", ...]
			    1: ["2025-04-22", "2025-04-28"],
			    2: ["2025-04-23", "2025-04-24"]
			  };
			  
			  flatpickrInstance = flatpickr("#dateRange", {
  			    mode: "range",
  			    dateFormat: "Y-m-d",
  			    minDate: "today",
  			    
  			    onChange: function(selectedDates) {
  			      if (selectedDates.length === 2) {
  			        document.getElementById("startDate").value = selectedDates[0].toISOString().slice(0, 10);
  			        document.getElementById("endDate").value = selectedDates[1].toISOString().slice(0, 10);
  			        calculateTotal(); // T√≠nh ti·ªÅn sau khi ch·ªçn ng√†y
  			      }
  			    }
  			  });

			  const pricePerPersonPerDay = 200000; // v√≠ d·ª•: 200.000 VND/ng∆∞·ªùi/ng√†y
			  
			  function fetchBusyDate(guideId) {
				console.log("fetchBusyDate guideId " + guideId)
				fetch(`/api/guides/${guideId}/busy-date`)
				    .then(response => response.json())
				    .then(data => {
						console.log("date  " + data.map(d => d.date))
						flatpickrInstance.set("disable", data.map(d => d.date));
						});
						
			  }

			  function openBookingPopup(guideId, guideName) {
			    document.getElementById("bookingModal").style.display = "flex";
			    document.getElementById("guideId").value = guideId;
			    document.getElementById("guideName").textContent = guideName;

			    document.getElementById("startDate").value = "";
			    document.getElementById("endDate").value = "";
			    document.getElementById("numPeople").value = 1;
			    document.getElementById("totalPrice").textContent = "0";
				
				
				fetchBusyDate(guideId)
			  }

			  function closeBookingPopup() {
			    document.getElementById("bookingModal").style.display = "none";
			  }

			  function calculateTotal() {
			    const start = new Date(document.getElementById("startDate").value);
			    const end = new Date(document.getElementById("endDate").value);
			    const people = parseInt(document.getElementById("numPeople").value);

			    if (!isNaN(start) && !isNaN(end) && people > 0 && end >= start) {
			      const days = (end - start) / (1000 * 60 * 60 * 24) + 1;
			      const total = days * people * pricePerPersonPerDay;
			      document.getElementById("totalPrice").textContent = total.toLocaleString();
			    }
			  }

			  document.getElementById("startDate").addEventListener("change", calculateTotal);
			  document.getElementById("endDate").addEventListener("change", calculateTotal);
			  document.getElementById("numPeople").addEventListener("input", calculateTotal);

			  // Optional: Validate unavailable dates
			  ["startDate", "endDate"].forEach(id => {
			    document.getElementById(id).addEventListener("change", function () {
			      const guideId = parseInt(document.getElementById("guideId").value);
			      const dateVal = this.value;
			      if (BusyDates[guideId]?.includes(dateVal)) {
			        alert("Ng√†y b·∫°n ch·ªçn ƒë√£ b·ªã ƒë·∫∑t, vui l√≤ng ch·ªçn ng√†y kh√°c.");
			        this.value = "";
			        calculateTotal();
			      }
			    });
			  });

			  document.getElementById("bookingForm").addEventListener("submit", function (e) {
			    e.preventDefault();
			    alert("ƒê·∫∑t l·ªãch th√†nh c√¥ng! (Demo)");
			    closeBookingPopup();
			  });
			</script>



		</div>
	</div>

	<footer th:replace="~{page-component :: footer}"></footer>

</body>

</html>