<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" th:href="@{/style.css}">
	<script th:src="@{/jquery-3.6.0.min.js}"></script>
	<script th:src="@{/app-script.js}"></script>
	<style>
		.post-card {
			border-radius: 10px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			transition: transform 0.2s ease-in-out;
		}

		.post-card-body {
			padding: 1.5rem;
		}

		.post-card-title {
			font-weight: bold;
			color: #333;
		}

		.post-card-footer {
			background-color: #f8f9fa;
			padding: 10px;
			border-top: 1px solid #ddd;
			display: flex;
			justify-content: start;
			gap: 10px;
		}

		.post-card .text-muted {
			font-size: 0.9rem;
		}

		.post-card strong {
			color: #555;
		}

		.post-card .like-comment-count {
			font-size: 1rem;
			font-weight: bold;
			color: #007bff;
		}

		.post-card .btn-like {
			background-color: #f8f9fa;
			border: 1px solid #007bff;
			color: #007bff;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-like:hover {
			background-color: #007bff;
			color: white;
		}

		.post-card .btn-comment {
			background-color: #f8f9fa;
			border: 1px solid #28a745;
			color: #28a745;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-comment:hover {
			background-color: #28a745;
			color: white;
		}

		.post-card .comment-section {
			border-top: 1px solid #ddd;
			margin-top: 15px;
			padding-top: 10px;
		}

		.post-card .comment-input {
			border-radius: 20px;
			padding: 10px;
		}

		.post-card .comment-form button {
			border-radius: 20px;
			margin-top: 10px;
		}

		.trip-card-home {
			border-radius: 12px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
			transition: transform 0.3s ease-in-out;
			padding: 20px;
		}

		.trip-card-home:hover {
			transform: scale(1.03);
		}

		.trip-card-home img {
			width: 100%;
			/* ƒê·∫£m b·∫£o ·∫£nh chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa container */
			height: 200px;
			/* ƒê·∫∑t chi·ªÅu cao c·ªë ƒë·ªãnh cho ·∫£nh */
			object-fit: cover;
			/* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã bi·∫øn d·∫°ng m√† v·∫´n ph·ªß k√≠n kh√¥ng gian */
		}
	</style>

</head>

<body>
	<nav th:replace="~{page-component :: header}"></nav>

	<div class="container-fluid page-title">
	    <div class="card p-3 shadow">
	        <h4 class="text-start mb-3" th:text="#{label.searchTrips}">T√¨m ki·∫øm chuy·∫øn ƒëi</h4>
	        <form th:action="@{/trips/search}" method="get">
	            <div class="row d-flex align-items-center g-2">
	                <!-- ƒê·ªãa ƒëi·ªÉm -->
	                <div class="col-md-2">
	                    <input type="text" name="location" class="form-control" th:placeholder="#{label.destination}">
	                </div>

	                <!-- Danh m·ª•c -->
	                <div class="col-md-2">
	                    <select id="category" name="category" class="form-select">
	                        <option value="" th:text="#{label.category}">Danh m·ª•c</option>
	                        <option th:each="cat : ${categories}" th:value="${cat}" th:text="${#messages.msg(cat.name())}"></option>
	                    </select>
	                </div>

	                <!-- Ng√¥n ng·ªØ -->
	                <div class="col-md-2">
	                    <input type="text" name="language" class="form-control" th:placeholder="#{label.language}">
	                </div>

	                <!-- Gi·ªõi t√≠nh -->
	                <div class="col-md-2">
	                    <select name="gender" class="form-select">
	                        <option value="" th:text="#{label.gender}">Gi·ªõi t√≠nh</option>
	                        <option value="MALE" th:text="#{MALE}">Nam</option>
	                        <option value="FEMALE" th:text="#{FEMALE}">N·ªØ</option>
	                    </select>
	                </div>

	                <!-- N√∫t t√¨m ki·∫øm -->
	                <div class="col-md-2 text-end">
	                    <button type="submit" class="btn btn-primary w-100"th:text="#{label.search}">üîç T√¨m ki·∫øm</button>
	                </div>
	            </div>
	        </form>
	    </div>
	</div>




	<div class="text-center page-title">
		<svg th:replace="~{icons :: destination}"></svg>
	</div>

	<h3 class="text-center" style="margin-top: 10px;" th:text="#{label.highlightTrips}">C√°c chuy·∫øn ƒëi n·ªïi b·∫≠t</h3>

	<div class="container mt-4">
		<div class="row">
			<!-- Loop through trips and display in cards -->
			<div th:each="trip : ${trips}" class="col-md-3 mb-4">
				<div class="card trip-card-home">
					<a th:href="@{/trips/{id}/details(id=${trip.id})}">
						<div class="row g-0">
							<!-- Column for image -->
							<div class="col-12">
								<!--<img th:src="${trip.tripPictureUrl != null ? @{${trip.tripPictureUrl}} : '/uploads/trip-default.png'}"
							     class="img-fluid rounded-top" alt="·∫¢nh chuy·∫øn ƒëi">-->

								<img th:src="${trip.tripPictureUrl != null and trip.tripPictureUrl != '' ? trip.tripPictureUrl : '/uploads/trip-default.png'}"
									class="img-fluid rounded-top" alt="·∫¢nh chuy·∫øn ƒëi">

							</div>
							<!-- Column for content -->
							<div class="col-12">
								<div class="trip-card-home-body">
									<h5 class="trip-card-home-title" th:text="${trip.title}">Ti√™u ƒë·ªÅ</h5>
									<p class="card-text" ><strong th:text="#{label.destination}">ƒê·ªãa ƒëi·ªÉm:</strong> <span
											th:text="${trip.destination}">ƒê·ªãa
											ƒëi·ªÉm</span></p>
									<p class="card-text">
										<strong th:text="#{label.duration}">Th·ªùi gian:</strong>
										<span th:text="${#temporals.format(trip.startDate, 'dd/MM/yyyy')}">Ng√†y b·∫Øt
											ƒë·∫ßu</span> -
										<span th:text="${#temporals.format(trip.endDate, 'dd/MM/yyyy')}">Ng√†y k·∫øt
											th√∫c</span>
									</p>
									<p class="card-text"><strong th:text="#{label.organizer}">Ng∆∞·ªùi t·ªï ch·ª©c:</strong> <span
											th:text="${trip.creator.fullName}">adnmin</span></p>
									<p class="card-text"><strong th:text="#{label.participants}">S·ªë ng∆∞·ªùi tham gia:</strong> <span
											th:text="${#lists.size(trip.participants)}">0</span></p>

									<div
										th:if="${session.loggedInUser != null && (trip.creator.id != session.loggedInUser.id)}">
										<!-- Check if the user has already joined the trip -->
										<p th:if="${participantStatus[trip.id]}" class="alert alert-success" th:text="#{label.alreadyJoined}">
											‚úÖ ƒê√£ tham gia
										</p>

										<!-- Check if the request is pending -->
										<p th:if="${requestStatus[trip.id]}" class="alert alert-warning" th:text="#{label.pendingApproval}">
											‚è≥ ƒêang ch·ªù duy·ªát
										</p>

										<!-- Show the Join button if the user hasn't joined or requested to join -->
										<form th:if="${!(participantStatus[trip.id] || requestStatus[trip.id])}"
											th:action="@{/trips/{id}/request(id=${trip.id})}" method="post">
											<button type="submit" class="alert alert-warning w-100" th:text="#{label.joinRequest}">
												Y√™u c·∫ßu tham gia
											</button>
										</form>
									</div>
									<p class="alert alert-success"
										th:if="${session.loggedInUser != null && (trip.creator.id == session.loggedInUser.id)}" th:text="#{label.alreadyJoined}">
										‚úÖ ƒê√£ tham gia
									</p>
								</div>
							</div>
						</div>
					</a>
				</div>
			</div>
		</div>
	</div>

	<div class="text-center page-title">
		<svg th:replace="~{icons :: blog}"></svg>
	</div>
	<h3 class="text-center" style="margin-top: 10px;">C√°c b√†i vi·∫øt n·ªïi b·∫≠t</h3>

	<div class="container mt-4">
		<div class="row">
			<div th:each="post : ${posts}" class="col-md-12">
				<div class="post-card mb-4">
					<div class="post-card-body">
						<h5 class="post-card-title" th:text="${post.title}"></h5>
						<p class="text-muted">
							<strong th:text="#{label.postedOn}"></strong>
							<span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
						</p>
						<p><strong th:text="#{label.author}"></strong> <span th:text="${post.author.fullName}"></span>
						</p>
						<p><strong th:text="#{label.category}"></strong> <span
								th:text="${#messages.msg(post.category.name)}"></span>
						</p>
						<p><strong th:text="#{label.content}"></strong> <span th:utext="${post.content}"></span></p>

						<p>
							<span class="like-comment-count">
								üëç <span th:id="'like-count-' + ${post.id}"
									th:text="${post.likes != null ? post.likes.size() : 0}">0</span> |
								üí¨ <span th:text="${post.comments != null ? post.comments.size() : 0}">0</span>
							</span>
						</p>
					</div>

					<div class="post-card-footer">
						<button class="btn btn-like btn-sm" th:id="'like-button-' + ${post.id}"
							th:attr="onclick='toggleLike(' + ${post.id} + ')'" th:text="#{label.like}">
						</button>

						<button class="btn btn-comment btn-sm" th:attr="onclick='loadComments(' + ${post.id} + ')'"
							th:text="#{label.viewComments}">
						</button>
					</div>

					<div class="post-card-body comment-section">
						<h6 class="post-card-title" th:text="#{label.comments}"></h6>
						<div th:id="'comment-section-' + ${post.id}" class="mt-3"></div>

						<!-- Form th√™m b√¨nh lu·∫≠n -->
						<form th:attr="onsubmit='addComment(event, ' + ${post.id} + ')'" class="comment-form">
							<input type="text" th:id="'comment-content-' + ${post.id}"
								class="form-control comment-input" th:placeholder="#{label.enterComment}" required>
							<button type="submit" class="btn btn-success btn-sm" th:text="#{label.send}"></button>
						</form>
					</div>
				</div>
			</div>

			<script>
				function toggleLike(postId) {
					fetch(`/api/likes/${postId}`, {method: 'POST'})
						.then(response => {
							if (!response.ok) {
								throw new Error(`L·ªói HTTP: ${response.status}`);
							}
							return response.json();
						})
						.then(data => {
							const likeCountElement = document.getElementById(`like-count-${postId}`);
							if (likeCountElement) {
								likeCountElement.innerText = data.likeCount;
							}

							const likeButton = document.getElementById(`like-button-${postId}`);
							if (likeButton) {
								likeButton.classList.toggle('liked', data.liked); // ƒê·ªïi class khi ƒë√£ th√≠ch
							}
						})
						.catch(error => console.error("L·ªói:", error));
				}

				function addComment(event, postId) {
					event.preventDefault();
					const content = document.getElementById(`comment-content-${postId}`).value;

					fetch(`/api/comments/post/${postId}`, {
						method: "POST",
						headers: {"Content-Type": "application/json"},
						body: JSON.stringify({content: content})
					})
						.then(response => response.json())
						.then(data => {
							loadComments(postId)
						})
						.catch(error => console.error("L·ªói:", error));
				}

				function loadComments(postId) {
					fetch(`/api/comments/post/${postId}`)
						.then(response => response.json())
						.then(comments => {
							let commentSection = document.getElementById(`comment-section-${postId}`);
							commentSection.innerHTML = ""; // X√≥a n·ªôi dung c≈©

							comments.forEach(comment => {
								let commentHtml = `
				                        <div class="mb-2">
				                            <p><strong>${comment.commenter.fullName}</strong></p>
				                            <p>${comment.content}</p>
				                            <p class="text-muted">
				                                <small>${new Date(comment.createdAt).toLocaleString()}</small>
				                            </p>
				                            <hr>
				                        </div>
				                    `;
								commentSection.innerHTML += commentHtml;
							});
						})
						.catch(error => console.error("Error loading comments:", error));
				}
			</script>
		</div>
	</div>

	<footer th:replace="~{page-component :: footer}"></footer>

</body>

</html>