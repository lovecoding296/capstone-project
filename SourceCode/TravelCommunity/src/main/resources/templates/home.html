<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!--<title th:text="#{logo}"></title>-->



	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" th:href="@{/style.css}">
	<script th:src="@{/jquery-3.6.0.min.js}"></script>
	<script th:src="@{/app-script.js}"></script>
	<style>
		.post-card {
			border-radius: 10px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			transition: transform 0.2s ease-in-out;
		}

		.post-card-body {
			padding: 1.5rem;
		}

		.post-card-title {
			font-weight: bold;
			color: #333;
		}

		.post-card-footer {
			background-color: #f8f9fa;
			padding: 10px;
			border-top: 1px solid #ddd;
			display: flex;
			justify-content: start;
			gap: 10px;
		}

		.post-card .text-muted {
			font-size: 0.9rem;
		}

		.post-card strong {
			color: #555;
		}

		.post-card .like-comment-count {
			font-size: 1rem;
			font-weight: bold;
			color: #007bff;
		}

		.post-card .btn-like {
			background-color: #f8f9fa;
			border: 1px solid #007bff;
			color: #007bff;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-like:hover {
			background-color: #007bff;
			color: white;
		}

		.post-card .btn-comment {
			background-color: #f8f9fa;
			border: 1px solid #28a745;
			color: #28a745;
			transition: all 0.3s ease-in-out;
		}

		.post-card .btn-comment:hover {
			background-color: #28a745;
			color: white;
		}

		.post-card .comment-section {
			border-top: 1px solid #ddd;
			margin-top: 15px;
			padding-top: 10px;
		}

		.post-card .comment-input {
			border-radius: 20px;
			padding: 10px;
		}

		.post-card .comment-form button {
			border-radius: 20px;
			margin-top: 10px;
		}

		.carousel-item {
			transition: transform 0.8s ease-in-out, opacity 0.8s ease-in-out;
		}

		.trip-card-home {
			border-radius: 12px;
			border: 1px solid #ddd;
			background: #fff;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
			transition: transform 0.3s ease-in-out;
			padding: 20px;
		}

		.trip-card-home:hover {
			transform: scale(1.03);
		}

		.carousel-control-prev-icon,
		.carousel-control-next-icon {
			filter: invert(1);
		}

		.carousel-control-prev,
		.carousel-control-next {
			width: 5%;
		}

		.carousel-control-prev-icon,
		.carousel-control-next-icon {
			background-color: rgba(0, 0, 0, 0.5);
			/* Màu nền tối để dễ nhìn hơn */
			border-radius: 50%;
			padding: 15px;
			width: 40px;
			height: 40px;
		}

		.carousel-control-prev:hover .carousel-control-prev-icon,
		.carousel-control-next:hover .carousel-control-next-icon {
			background-color: rgba(0, 0, 0, 0.8);
		}

		.carousel-item {
			transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
		}
	</style>


</head>

<body>
	<!--<nav th:replace="~{page-component :: header}"></nav>
	<footer th:replace="~{page-component :: footer}"></footer>-->

	<nav th:replace="~{page-component :: header}"></nav>

	<div class="text-center page-title">
		<svg th:replace="~{icons :: destination}"></svg>
	</div>

	<h3 class="text-center" style="margin-top: 10px;">Danh sách các chuyến đi</h3>

	<div id="tripCarousel" class="carousel slide" data-bs-ride="carousel">
		<div class="carousel-inner">
			<div th:each="trip, iterStat : ${trips}" th:if="${iterStat.index % 2 == 0}" class="carousel-item"
				th:classappend="${iterStat.index == 0} ? 'active'">
				<div class="row justify-content-center">

					<div class="col-md-5 mx-2" th:if="${trips[iterStat.index] != null}">
						<div class="card trip-card-home">
							<div class="row g-0">
								<!-- Cột chứa ảnh -->
								<div class="col-md-4">
									<img th:src="${trips[iterStat.index].tripPictureUrl != null} ? @{${trips[iterStat.index].tripPictureUrl}} : '/uploads/trip-default.png'"
										class="img-fluid rounded-start" alt="Ảnh chuyến đi">

								</div>
								<!-- Cột chứa nội dung -->
								<div class="col-md-8">
									<div class="trip-card-home-body">
										<h5 class="trip-card-home-title" th:text="${trips[iterStat.index].title}">Tiêu
											đề</h5>
										<p class="card-text"><strong>Địa điểm:</strong> <span
												th:text="${trips[iterStat.index].destination}">Địa điểm</span></p>
										<p class="card-text">
											<strong>Thời gian:</strong>
											<span
												th:text="${#temporals.format(trips[iterStat.index].startDate, 'dd/MM/yyyy')}">
												Ngày bắt đầu</span> -
											<span
												th:text="${#temporals.format(trips[iterStat.index].endDate, 'dd/MM/yyyy')}">
												Ngày kết thúc</span>
										</p>
										<p class="card-text"><strong>Người tổ chức:</strong>
											<span th:text="${trips[iterStat.index].creator.fullName}">Người tổ
												chức</span>
										</p>
										<p class="card-text"><strong>Số người tham gia:</strong>
											<span th:text="${#lists.size(trips[iterStat.index].participants)}">0</span>
										</p>

										<div th:if="${participantStatus != null}">
											<div th:if="${participantStatus[trips[iterStat.index].id]}"
												class="alert alert-success">
												✅ Bạn đã tham gia chuyến đi này
											</div>
											<div th:if="${requestStatus[trips[iterStat.index].id]}"
												class="alert alert-warning">
												⏳ Yêu cầu tham gia đang chờ duyệt
											</div>
										</div>

										<a th:href="@{/trips/{id}/details(id=${trips[iterStat.index].id})}"
											class="btn btn-info">Xem chi tiết</a>
									</div>
								</div>
							</div>
						</div>
					</div>


					<!-- Chuyến đi 2 -->
					<div class="col-md-5 mx-2" th:if="${iterStat.index + 1 < trips.size()}">
						<div class="card trip-card-home">
							<div class="row g-0">
								<!-- Cột chứa ảnh -->
								<div class="col-md-4">
									<img th:src="${trips[iterStat.index + 1].tripPictureUrl != null} ? @{${trips[iterStat.index + 1].tripPictureUrl}} : '/uploads/trip-default.png'"
										class="img-fluid rounded-start" alt="Ảnh chuyến đi">
								</div>

								<!-- Cột chứa nội dung -->
								<div class="col-md-8">
									<div class="trip-card-home-body">
										<h5 class="trip-card-home-title" th:text="${trips[iterStat.index + 1].title}">
											Tiêu đề
										</h5>
										<p class="card-text"><strong>Địa điểm:</strong> <span
												th:text="${trips[iterStat.index + 1].destination}">Địa điểm</span></p>
										<p class="card-text">
											<strong>Thời gian:</strong>
											<span
												th:text="${#temporals.format(trips[iterStat.index + 1].startDate, 'dd/MM/yyyy')}">Ngày
												bắt đầu</span> -
											<span
												th:text="${#temporals.format(trips[iterStat.index + 1].endDate, 'dd/MM/yyyy')}">Ngày
												kết thúc</span>
										</p>
										<p class="card-text"><strong>Người tổ chức:</strong> <span
												th:text="${trips[iterStat.index + 1].creator.fullName}">Người tổ
												chức</span></p>
										<p class="card-text"><strong>Số người tham gia:</strong> <span
												th:text="${#lists.size(trips[iterStat.index + 1].participants)}">0</span>
										</p>
										<div th:if="${participantStatus != null}">
											<div th:if="${participantStatus[trips[iterStat.index + 1].id]}"
												class="alert alert-success">
												✅ Bạn đã tham gia chuyến đi này
											</div>
											<div th:if="${requestStatus[trips[iterStat.index + 1].id]}"
												class="alert alert-warning">
												⏳ Yêu cầu tham gia đang chờ duyệt
											</div>
											<!--<form
										th:unless="${participantStatus[trips[iterStat.index + 1].id] || requestStatus[trips[iterStat.index + 1].id]}"
										th:action="@{/trips/{id}/request(id=${trips[iterStat.index + 1].id})}"
										method="post">
										<button type="submit" class="btn btn-primary">Yêu cầu tham gia</button>
									</form>-->
										</div>


										<a th:href="@{/trips/{id}/details(id=${trips[iterStat.index + 1].id})}"
											class="btn btn-info">Xem chi tiết</a>



									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Nút điều hướng -->
		<button class="carousel-control-prev" type="button" data-bs-target="#tripCarousel" data-bs-slide="prev">
			<span class="carousel-control-prev-icon d-flex align-items-center justify-content-center">
				<i class="fas fa-chevron-left text-white"></i>
			</span>
		</button>
		<button class="carousel-control-next" type="button" data-bs-target="#tripCarousel" data-bs-slide="next">
			<span class="carousel-control-next-icon d-flex align-items-center justify-content-center">
				<i class="fas fa-chevron-right text-white"></i>
			</span>
		</button>
	</div>



	<div class="text-center page-title">
		<svg th:replace="~{icons :: blog}"></svg>
	</div>
	<h3 class="text-center" style="margin-top: 10px;">Danh sách bài viết</h3>
	<div class="container mt-4">
		<div class="row">
			<div th:each="post : ${posts}" class="col-md-12">
				<div class="post-card mb-4">
					<div class="post-card-body">
						<h5 class="post-card-title" th:text="${post.title}">Tiêu đề</h5>
						<p class="text-muted">
							<strong>Ngày đăng:</strong>
							<span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">Ngày
								đăng</span>
						</p>
						<p><strong>Tác giả:</strong> <span th:text="${post.author.fullName}">Tác giả</span></p>
						<p><strong>Nội dung:</strong> <span th:utext="${post.content}">Nội dung</span></p>

						<p>
							<span class="like-comment-count">
								👍 <span th:id="'like-count-' + ${post.id}"
									th:text="${post.likes != null ? post.likes.size() : 0}">0</span> |
								💬 <span th:text="${post.comments != null ? post.comments.size() : 0}">0</span>
							</span>
						</p>
					</div>

					<div class="post-card-footer">
						<!-- Nút Thích -->
						<button class="btn btn-like btn-sm" th:id="'like-button-' + ${post.id}"
							th:attr="onclick='toggleLike(' + ${post.id} + ')'">
							👍 Thích
						</button>

						<button class="btn btn-comment btn-sm" th:attr="onclick='loadComments(' + ${post.id} + ')'">
							💬 Xem bình luận
						</button>
					</div>

					<div class="post-card-body comment-section">
						<h6 class="post-card-title">Bình luận:</h6>
						<div th:id="'comment-section-' + ${post.id}" class="mt-3"></div>

						<!-- Form thêm bình luận -->
						<form th:attr="onsubmit='addComment(event, ' + ${post.id} + ')'" class="comment-form">
							<input type="text" th:id="'comment-content-' + ${post.id}"
								class="form-control comment-input" placeholder="Nhập bình luận..." required>
							<button type="submit" class="btn btn-success btn-sm">Gửi</button>
						</form>
					</div>
				</div>
			</div>


			<script>
				function toggleLike(postId) {
					fetch(`/api/likes/${postId}`, {method: 'POST'})
						.then(response => {
							if (!response.ok) {
								throw new Error(`Lỗi HTTP: ${response.status}`);
							}
							return response.json();
						})
						.then(data => {
							const likeCountElement = document.getElementById(`like-count-${postId}`);
							if (likeCountElement) {
								likeCountElement.innerText = data.likeCount;
							}

							const likeButton = document.getElementById(`like-button-${postId}`);
							if (likeButton) {
								likeButton.classList.toggle('liked', data.liked); // Đổi class khi đã thích
							}
						})
						.catch(error => console.error("Lỗi:", error));
				}


				function addComment(event, postId) {
					event.preventDefault();
					const content = document.getElementById(`comment-content-${postId}`).value;

					fetch(`/api/comments/post/${postId}`, {
						method: "POST",
						headers: {"Content-Type": "application/json"},
						body: JSON.stringify({content: content})
					})
						.then(response => response.json())
						.then(data => {
							//location.reload(); // Refresh trang để thấy comment mới
							console.log("data " + data)
							loadComments(postId)
						})
						.catch(error => console.error("Lỗi:", error));
				}

				function loadComments(postId) {
					fetch(`/api/comments/post/${postId}`)
						.then(response => response.json())
						.then(comments => {
							let commentSection = document.getElementById(`comment-section-${postId}`);
							commentSection.innerHTML = ""; // Xóa nội dung cũ

							comments.forEach(comment => {
								let commentHtml = `
				                        <div class="mb-2">
				                            <p><strong>${comment.commenter.fullName}</strong></p>
				                            <p>${comment.content}</p>
				                            <p class="text-muted">
				                                <small>${new Date(comment.createdAt).toLocaleString()}</small>
				                            </p>
				                            <hr>
				                        </div>
				                    `;
								commentSection.innerHTML += commentHtml;
							});
						})
						.catch(error => console.error("Error loading comments:", error));
				}
			</script>

			<script>
				function requestJoinTrip(tripId) {
					fetch(`/trips/${tripId}/request`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json"
						}
					})
						.then(response => {
							console.log(response)
							if (!response.ok) {
								throw new Error("Lỗi khi gửi yêu cầu");
							}
							return response.json();
						})
						.then(data => {
							alert("✅ Yêu cầu tham gia đã được gửi thành công!");
							document.getElementById(`join-trip-${tripId}`).disabled = true; // Vô hiệu hóa nút sau khi gửi
						})
						.catch(error => {
							console.error("Lỗi:", error);
							alert("❌ Có lỗi xảy ra, vui lòng thử lại sau.");
						});
				}
			</script>




		</div>
	</div>





	<footer th:replace="~{page-component :: footer}"></footer>



</body>

</html>